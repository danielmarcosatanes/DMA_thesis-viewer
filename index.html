<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMA Thesis | 3D Mechanistic Viewer</title>

    <!-- FAVICON: √Åtomo ‚öõÔ∏è -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚öõÔ∏è</text></svg>">

    <link rel="stylesheet" href="styles.css">
    <script type="text/javascript" src="JSmol.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body class="light-mode">

    <button id="sidebar-toggle" class="mobile-toggle" onclick="toggleSidebar()">‚ò∞ Menu</button>

    <div id="main-wrapper">
        <!-- SIDEBAR -->
        <nav id="sidebar">
            <header class="sidebar-header">
                <h1>Daniel Marcos</h1>
                <p class="tagline">Mechanistic Explorer</p>

                <div class="theme-switch-wrapper">
                    <label class="theme-switch">
                        <input type="checkbox" id="dark-mode-checkbox" onclick="toggleDarkMode()" />
                        <div class="slider round"></div>
                    </label>
                    <span id="theme-text">Light Mode</span>
                </div>
                <input type="text" id="sidebar-search" placeholder="Search intermediate..." onkeyup="searchMenu()">
            </header>

            <div id="menu">
                <a href="#" id="home-link" class="active" onclick="showHomePage(); setActiveLink('home-link')">üè† Home Overview</a>
                <!-- El √°rbol se inyecta aqu√≠ -->
            </div>

            <div class="sidebar-footer">
                <a href="https://daniel-marcosatanes.github.io/" target="_blank">Back to Portfolio</a>
            </div>
        </nav>

        <!-- CONTENIDO PRINCIPAL -->
        <main id="main-content">
            <div id="dynamic-content" class="container-inner">
                <!-- Se inyecta por JS -->
            </div>
        </main>
    </div>

<script>
    // --- 1. DATOS DEL PERFIL ENERG√âTICO ---
    const energyDataL28 = [
        { id: "L28-Ir(Bpin)3", label: "Resting State", energy: 0.0, x: 80, path: "molecules/Structures/Structures section 7.3/Borylation of 44a/Bis-5-CF3-Bipy/Ir(Bpin)3/L28-Ir(Bpin)3.log" },
        { id: "L28-œÉ-(R-H)Ir(Bpin)3", label: "œÉ-complex", energy: 0.8, x: 160, path: "molecules/Structures/Structures section 7.3/Borylation of 44a/Bis-5-CF3-Bipy/OA/œÉ-(R-H)Ir(Bpin)3/L28-œÉ-(R-H)Ir(Bpin)3.log" },
        { id: "L28-OA-TS-Ir(R-H)(Bpin)3", label: "OA-TS", energy: 24.3, x: 240, path: "molecules/Structures/Structures section 7.3/Borylation of 44a/Bis-5-CF3-Bipy/OA/OA-TS-Ir(R-H)(Bpin)3/L28-OA-TS-Ir(R-H)(Bpin)3.log" },
        { id: "L28-Ir(Bpin)3(R)(H)", label: "Intermediate", energy: 12.9, x: 320, path: "molecules/Structures/Structures section 7.3/Borylation of 44a/Bis-5-CF3-Bipy/OA/Ir(Bpin)3(R)(H)/L28-Ir(Bpin)3(R)(H).log" },
        { id: "L28-isomH-TS-Ir(Bpin)3(R)(H)", label: "isomH-TS", energy: 30.5, x: 420, path: "molecules/Structures/Structures section 7.3/Borylation of 44a/Bis-5-CF3-Bipy/Isom-H/isomH-TS-Ir(Bpin)3(R)(H)/L28-isomH-TS-Ir(Bpin)3(R)(H).log", color: "#e29578" },
        { id: "L28-isoH-Ir(Bpin)3(R)(H)", label: "isoH-Intermediate", energy: 18.1, x: 520, path: "molecules/Structures/Structures section 7.3/Borylation of 44a/Bis-5-CF3-Bipy/Isom-H/isoH-Ir(Bpin)3(R)(H)/L28-isoH-Ir(Bpin)3(R)(H).log", color: "#e29578" },
        { id: "L28-RE-TS-isoH-Ir(Bpin)3(R)(H)", label: "RE-TS (H)", energy: 32.3, x: 620, path: "molecules/Structures/Structures section 7.3/Borylation of 44a/Bis-5-CF3-Bipy/Isom-H/RE-TS-isoH-Ir(Bpin)3(R)(H)/L28-RE-TS-isoH-Ir(Bpin)3(R)(H).log", color: "#e29578" }
    ];

    // ---2. MAPEO DE CARPETAS ---
    const structureData = {
        "Structures section 7.1": [
            "4-m-bipy-OA-TS-Ir(R-H)(Bpin)3.log", "4-p-bipy-OA-TS-Ir(R-H)(Bpin)3.log",
            "5-m-phen-OA-TS-Ir(R-H)(Bpin)3.log", "5-OR-bipy-OA-TS-Ir(R-H)(Bpin)3.log",
            "5-p-phen-OA-TS-Ir(R-H)(Bpin)3.log", "bipy-OA-TS-Ir(R-H)(Bpin)3.log"
        ],
        "Structures section 7.2": {
            "3-CF3-Bipy": { "Meta": ["3-CF3-Bipy_TS_m-31.log"], "Ortho": ["3-CF3-Bipy_TS_o-2.log"], "Para": ["3-CF3-Bipy_TS_p-1.log"] },
            "4-CF3-Bipy": { "Meta": ["4-CF3-Bipy_TS_m-8.log"], "Ortho": ["4-CF3-Bipy_TS_o-3.log"], "Para": ["4-CF3-Bipy_TS_p-3.log"] },
            "5-CF3-Bipy": { "Meta": ["5-CF3-Bipy_TS_m-5.log"], "Ortho": ["5-CF3-Bipy_TSOA_o-1.log"], "Para": ["5-CF3-Bipy_TSOA_p-1.log"] },
            "Bipy": { "Meta": ["Bipy_TS_m-3.log"], "Ortho": ["Bipy_TS_o-1.log"], "Para": ["Bipy_TS_p-1.log"] }
        },
        "Structures section 7.3": {
            "Borylation of 44a": {
                "5-CF3-Bipy": {
                    "Ir(Bpin)": ["L27-Ir(Bpin).log"], "Ir(Bpin)3": ["L27-Ir(Bpin)3.log"], "Ir(Bpin)5": ["L27-Ir(Bpin)5.log"], "Ir(H)(Bpin)2": ["L27-Ir(H)(Bpin)2.log"],
                    "Isom-H": {
                        "œÉ-isoH-(R-Bpin)Ir(Bpin)2(H)": ["L27-œÉ-isoH-(R-Bpin)Ir(Bpin)2(H).log"],
                        "isoH-Ir(Bpin)3(R)(H)": ["L27-isoH-Ir(Bpin)3(R)(H).log"],
                        "isomH-TS-Ir(Bpin)3(R)(H)": ["L27-isomH-TS-Ir(Bpin)3(R)(H).log"],
                        "RE-TS-isoH-Ir(Bpin)3(R)(H)": ["L27-RE-TS-isoH-Ir(Bpin)3(R)(H).log"]
                    },
                    "Isom-S": {
                        "œÉ-isoS-(R-Bpin)Ir(Bpin)2(H)": ["L27-œÉ-isoS-(R-Bpin)Ir(Bpin)2(H).log"],
                        "isomS-TS-Ir(Bpin)3(R)(H)": ["L27-isomS-TS-Ir(Bpin)3(R)(H).log"],
                        "isoS-Ir(Bpin)3(R)(H)": ["L27-isoS-Ir(Bpin)3(R)(H).log"],
                        "RE-TS-isoS-Ir(Bpin)3(R)(H)": ["L27-RE-TS-isoS-Ir(Bpin)3(R)(H).log"]
                    },
                    "OA": {
                        "œÉ-(R-H)Ir(Bpin)3": ["L27-œÉ-(R-H)Ir(Bpin)3.log"],
                        "Ir(Bpin)3(R)(H)": ["L27-Ir(Bpin)3(R)(H).log"],
                        "OA-TS-Ir(R-H)(Bpin)3": ["L27-OA-TS-Ir(R-H)(Bpin)3.log"]
                    },
                    "RE": {
                        "œÉ-iso-(R-Bpin)Ir(Bpin)2(H)": ["L27-œÉ-iso-(R-Bpin)Ir(Bpin)2(H).log"],
                        "RE-TS-Ir(Bpin)3(R)(H)": ["L27-RE-TS-Ir(Bpin)3(R)(H).log"]
                    }
                },
                "Bipy": {
                    "Ir(Bpin)": ["Bipy-Ir(Bpin).log"], "Ir(Bpin)3": ["Bipy-Ir(Bpin)3.log"], "Ir(Bpin)5": ["Bipy-Ir(Bpin)5.log"], "Ir(H)(Bpin)2": ["Bipy-Ir(H)(Bpin)2.log"],
                    "Isom-H": {
                        "œÉ-isoH-(R-Bpin)Ir(Bpin)2(H)": ["Bipy-œÉ-isoH-(R-Bpin)Ir(Bpin)2(H).log"],
                        "isoH-Ir(Bpin)3(R)(H)": ["Bipy-isoH-Ir(Bpin)3(R)(H).log"],
                        "isomH-TS-Ir(Bpin)3(R)(H)": ["Bipy-isomH-TS-Ir(Bpin)3(R)(H).log"],
                        "RE-TS-isoH-Ir(Bpin)3(R)(H)": ["Bipy-RE-TS-isoH-Ir(Bpin)3(R)(H).log"]
                    },
                    "Isom-S": {
                        "œÉ-isoS-(R-Bpin)Ir(Bpin)2(H)": ["Bipy-œÉ-isoS-(R-Bpin)Ir(Bpin)2(H).log"],
                        "isomS-TS-Ir(Bpin)3(R)(H)": ["Bipy-isomS-TS-Ir(Bpin)3(R)(H).log"],
                        "isoS-Ir(Bpin)3(R)(H)": ["Bipy-isoS-Ir(Bpin)3(R)(H).log"],
                        "RE-TS-isoS-Ir(Bpin)3(R)(H)": ["Bipy-RE-TS-isoS-Ir(Bpin)3(R)(H).log"]
                    },
                    "OA": {
                        "œÉ-(R-H)Ir(Bpin)3": ["Bipy-œÉ-(R-H)Ir(Bpin)3.log"],
                        "Ir(Bpin)3(R)(H)": ["Bipy-Ir(Bpin)3(R)(H).log"],
                        "OA-TS-Ir(R-H)(Bpin)3": ["Bipy-OA-TS-Ir(R-H)(Bpin)3.log"]
                    },
                    "RE": {
                        "œÉ-iso-(R-Bpin)Ir(Bpin)2(H)": ["Bipy-œÉ-iso-(R-Bpin)Ir(Bpin)2(H).log"],
                        "RE-TS-Ir(Bpin)3(R)(H)": ["Bipy-RE-TS-Ir(Bpin)3(R)(H).log"]
                    }
                },
                "Bis-5-CF3-Bipy": {
                    "Interactive Mechanism": "VIEW_L28_MECHANISM",
                    "Ir(Bpin)": ["L28-Ir(Bpin).log"], "Ir(Bpin)3": ["L28-Ir(Bpin)3.log"], "Ir(Bpin)5": ["L28-Ir(Bpin)5.log"], "Ir(H)(Bpin)2": ["L28-Ir(H)(Bpin)2.log"],
                    "Isom-H": {
                        "œÉ-isoH-(R-Bpin)Ir(Bpin)2(H)": ["L28-œÉ-isoH-(R-Bpin)Ir(Bpin)2(H).log"],
                        "isoH-Ir(Bpin)3(R)(H)": ["L28-isoH-Ir(Bpin)3(R)(H).log"],
                        "isomH-TS-Ir(Bpin)3(R)(H)": ["L28-isomH-TS-Ir(Bpin)3(R)(H).log"],
                        "RE-TS-isoH-Ir(Bpin)3(R)(H)": ["L28-RE-TS-isoH-Ir(Bpin)3(R)(H).log"]
                    },
                    "Isom-S": {
                        "œÉ-isoS-(R-Bpin)Ir(Bpin)2(H)": ["L28-œÉ-isoS-(R-Bpin)Ir(Bpin)2(H).log"],
                        "isomS-TS-Ir(Bpin)3(R)(H)": ["L28-isomS-TS-Ir(Bpin)3(R)(H).log"],
                        "isoS-Ir(Bpin)3(R)(H)": ["L28-isoS-Ir(Bpin)3(R)(H).log"],
                        "RE-TS-isoS-Ir(Bpin)3(R)(H)": ["L28-RE-TS-isoS-Ir(Bpin)3(R)(H).log"]
                    },
                    "OA": {
                        "œÉ-(R-H)Ir(Bpin)3": ["L28-œÉ-(R-H)Ir(Bpin)3.log"],
                        "Ir(Bpin)3(R)(H)": ["L28-Ir(Bpin)3(R)(H).log"],
                        "OA-TS-Ir(R-H)(Bpin)3": ["L28-OA-TS-Ir(R-H)(Bpin)3.log"]
                    },
                    "RE": {
                        "œÉ-iso-(R-Bpin)Ir(Bpin)2(H)": ["L28-œÉ-iso-(R-Bpin)Ir(Bpin)2(H).log"],
                        "RE-TS-Ir(Bpin)3(R)(H)": ["L28-RE-TS-Ir(Bpin)3(R)(H).log"]
                    }
                }
            },
            "Borylation of 44c": {
                "5-CF3": {
                    "Isom-H": {
                        "œÉ-isoH-(R-Bpin)Ir(Bpin)2(H)": ["L27-œÉ-isoH-(R-Bpin)Ir(Bpin)2(H).log"],
                        "isoH-Ir(Bpin)3(R)(H)": ["L27-isoH-Ir(Bpin)3(R)(H).log"],
                        "isomH-TS-Ir(Bpin)3(R)(H)": ["L27-isomH-TS-Ir(Bpin)3(R)(H).log"],
                        "RE-TS-isoH-Ir(Bpin)3(R)(H)": ["L27-RE-TS-isoH-Ir(Bpin)3(R)(H).log"]
                    },
                    "Isom-S": {
                        "œÉ-isoS-(R-Bpin)Ir(Bpin)2(H)": ["L27-œÉ-isoS-(R-Bpin)Ir(Bpin)2(H).log"],
                        "isomS-TS-Ir(Bpin)3(R)(H)": ["L27-isomS-TS-Ir(Bpin)3(R)(H).log"],
                        "isoS-Ir(Bpin)3(R)(H)": ["L27-isoS-Ir(Bpin)3(R)(H).log"],
                        "RE-TS-isoS-Ir(Bpin)3(R)(H)": ["L27-RE-TS-isoS-Ir(Bpin)3(R)(H).log"]
                    },
                    "OA": {
                        "œÉ-(R-H)Ir(Bpin)3": ["L27-œÉ-(R-H)Ir(Bpin)3.log"],
                        "Ir(Bpin)3(R)(H)": ["L27-Ir(Bpin)3(R)(H).log"],
                        "OA-TS-Ir(R-H)(Bpin)3": ["L27-OA-TS-Ir(R-H)(Bpin)3.log"]
                    },
                    "RE": {
                        "œÉ-iso-(R-Bpin)Ir(Bpin)2(H)": ["L27-œÉ-iso-(R-Bpin)Ir(Bpin)2(H).log"],
                        "RE-TS-Ir(Bpin)3(R)(H)": ["L27-RE-TS-Ir(Bpin)3(R)(H).log"]
                    }
                },
                "Bipy": {
                    "Isom-H": {
                        "œÉ-isoH-(R-Bpin)Ir(Bpin)2(H)": ["Bipy-œÉ-isoH-(R-Bpin)Ir(Bpin)2(H).log"],
                        "isoH-Ir(Bpin)3(R)(H)": ["Bipy-isoH-Ir(Bpin)3(R)(H).log"],
                        "isomH-TS-Ir(Bpin)3(R)(H)": ["Bipy-isomH-TS-Ir(Bpin)3(R)(H).log"],
                        "RE-TS-isoH-Ir(Bpin)3(R)(H)": ["Bipy-RE-TS-isoH-Ir(Bpin)3(R)(H).log"]
                    },
                    "OA": {
                        "œÉ-(R-H)Ir(Bpin)3": ["Bipy-œÉ-(R-H)Ir(Bpin)3.log"],
                        "Ir(Bpin)3(R)(H)": ["Bipy-Ir(Bpin)3(R)(H).log"],
                        "OA-TS-Ir(R-H)(Bpin)3": ["Bipy-OA-TS-Ir(R-H)(Bpin)3.log"]
                    }
                },
                "Bis-5-CF3-Bipy": {
                    "Isom-H": {
                        "œÉ-isoH-(R-Bpin)Ir(Bpin)2(H)": ["L28-œÉ-isoH-(R-Bpin)Ir(Bpin)2(H).log"],
                        "isoH-Ir(Bpin)3(R)(H)": ["L28-isoH-Ir(Bpin)3(R)(H).log"],
                        "isomH-TS-Ir(Bpin)3(R)(H)": ["L28-isomH-TS-Ir(Bpin)3(R)(H).log"],
                        "RE-TS-isoH-Ir(Bpin)3(R)(H)": ["L28-RE-TS-isoH-Ir(Bpin)3(R)(H).log"]
                    },
                    "OA": {
                        "œÉ-(R-H)Ir(Bpin)3": ["L28-œÉ-(R-H)Ir(Bpin)3.log"],
                        "Ir(Bpin)3(R)(H)": ["L28-Ir(Bpin)3(R)(H).log"],
                        "OA-TS-Ir(R-H)(Bpin)3": ["L28-OA-TS-Ir(R-H)(Bpin)3.log"]
                    }
                }
            },
            "Borylation of 44f": {
                "C-CH3": {
                    "5-CF3-Bipy": {
                        "OA": {
                            "œÉ-(R-H)Ir(Bpin)3": ["L27-œÉ-(R-H)Ir(Bpin)3.log"],
                            "Ir(Bpin)3(R)(H)": ["L27-Ir(Bpin)3(R)(H).log"],
                            "OA-TS-Ir(R-H)(Bpin)3": ["L27-OA-TS-Ir(R-H)(Bpin)3.log"]
                        }
                    },
                    "Bipy": {
                        "OA": {
                            "œÉ-(R-H)Ir(Bpin)3": ["Bipy-œÉ-(R-H)Ir(Bpin)3.log"],
                            "Ir(Bpin)3(R)(H)": ["Bipy-Ir(Bpin)3(R)(H).log"],
                            "OA-TS-Ir(R-H)(Bpin)3": ["Bipy-OA-TS-Ir(R-H)(Bpin)3.log"]
                        }
                    },
                    "Bis-5-CF3-Bipy": {
                        "OA": {
                            "œÉ-(R-H)Ir(Bpin)3": ["L28-œÉ-(R-H)Ir(Bpin)3.log"],
                            "Ir(Bpin)3(R)(H)": ["L28-Ir(Bpin)3(R)(H).log"],
                            "OA-TS-Ir(R-H)(Bpin)3": ["L28-OA-TS-Ir(R-H)(Bpin)3.log"]
                        }
                    }
                },
                "N-CH3": {
                    "5-CF3-Bipy": {
                        "OA": {
                            "œÉ-(R-H)Ir(Bpin)3": ["L27-œÉ-(R-H)Ir(Bpin)3.log"],
                            "Ir(Bpin)3(R)(H)": ["L27-Ir(Bpin)3(R)(H).log"],
                            "OA-TS-Ir(R-H)(Bpin)3": ["L27-OA-TS-Ir(R-H)(Bpin)3.log"]
                        }
                    },
                    "Bipy": {
                        "OA": {
                            "œÉ-(R-H)Ir(Bpin)3": ["Bipy-œÉ-(R-H)Ir(Bpin)3.log"],
                            "Ir(Bpin)3(R)(H)": ["Bipy-Ir(Bpin)3(R)(H).log"],
                            "OA-TS-Ir(R-H)(Bpin)3": ["Bipy-OA-TS-Ir(R-H)(Bpin)3.log"]
                        }
                    },
                    "Bis-5-CF3-Bipy": {
                        "OA": {
                            "œÉ-(R-H)Ir(Bpin)3": ["L28-œÉ-(R-H)Ir(Bpin)3.log"],
                            "Ir(Bpin)3(R)(H)": ["L28-Ir(Bpin)3(R)(H).log"],
                            "OA-TS-Ir(R-H)(Bpin)3": ["L28-OA-TS-Ir(R-H)(Bpin)3.log"]
                        }
                    }
                }
            },
            "Borylation of 44u": {
                "Bis-5-CF3-Bipy": {
                    "OA": {
                        "œÉ-(R-H)Ir(Bpin)3": ["L28-œÉ-(R-H)Ir(Bpin)3.log"],
                        "Ir(Bpin)3(R)(H)": ["L28-Ir(Bpin)3(R)(H).log"],
                        "OA-TS-Ir(R-H)(Bpin)3": ["L28-OA-TS-Ir(R-H)(Bpin)3.log"]
                    }
                }
            },
            "Rollover": {
                "Bipy": {
                    "Hemilabile-TS": ["Bipy-Hemilabile-TS.log"],
                    "Ir-(L)-Bpin3": ["Bipy-Ir-(L)-Bpin3.log"],
                    "Ir(LX)Bpin2": ["Bipy-Ir(LX)Bpin2.log"],
                    "Ligand_C-H-TS": ["Bipy-Ligand_C-H-TS.log"],
                    "OA-TS-Ir(LX)(R-H)(Bpin)3": ["Bipy-OA-TS-Ir(LX)(R-H)(Bpin)3.log"]
                },
                "Bis-5-CF3-Bipy": {
                    "Hemilabile-TS": ["L28-Hemilabile-TS.log"],
                    "Ir-(L)-Bpin3": ["L28-Ir-(L)-Bpin3.log"],
                    "Ir(LX)(Bpin)2": ["L28-Ir(LX)(Bpin)2.log"],
                    "Ligand_C-H-TS": ["L28-Ligand_C-H-TS.log"],
                    "OA-TS-Ir(LX)(R-H)(Bpin)3": ["L28-OA-TS-Ir(LX)(R-H)(Bpin)3.log"]
                }
            }
        }
    };

        // --- 3. VARIABLES Y FUNCIONES DE APOYO ---
        let myJmol = null;
        let isDarkMode = false;
        let hShow = true;

        function beautify(name) {
            return name.replace("Structures section ", "Section ")
                       .replace("Borylation of ", "Boryl. ");
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            document.getElementById('theme-text').textContent = isDarkMode ? "Dark Mode" : "Light Mode";
            if (myJmol) {
                const newBg = isDarkMode ? "#161616" : "#fdfdfd";
                Jmol.script(myJmol, `background "${newBg}";`);
            }
        }

        // --- 4. GENERADOR DE MEN√ö ---
        function createSidebarMenu(data, parent, currentPath = "molecules/Structures", level = 0) {
            if (!parent) return;
            Object.keys(data).forEach((key) => {
                if (data[key] === "VIEW_L28_MECHANISM") {
                    const mechLink = document.createElement("a");
                    mechLink.innerHTML = "üó∫Ô∏è <b>Interactive Map</b>";
                    mechLink.className = "file-link mechanism-btn";
                    mechLink.onclick = (e) => { e.stopPropagation(); showMechanismL28(); };
                    parent.appendChild(mechLink);
                    return;
                }

                const folderPath = `${currentPath}/${key}`;
                const safeId = "ID_" + folderPath.replace(/[^a-zA-Z0-9]/g, '_');
                const displayName = beautify(key);

                const link = document.createElement("a");
                link.textContent = (level === 0 ? "‚óè " : "") + displayName;
                link.className = (level === 0) ? "folder-link level-0" : "folder-link";
                link.onclick = (e) => { e.preventDefault(); toggleSection(safeId); };
                parent.appendChild(link);

                const subDiv = document.createElement("div");
                subDiv.id = safeId;
                subDiv.className = "submenu";
                subDiv.style.display = "none";

                if (Array.isArray(data[key])) {
                    data[key].forEach((file) => {
                        const moleculeName = file.replace('.log', '');
                        const fileLink = document.createElement("a");
                        fileLink.textContent = moleculeName;
                        fileLink.className = "file-link";
                        fileLink.onclick = (e) => {
                            e.stopPropagation();
                            loadMolecule(`${folderPath}/${file}`, moleculeName);
                        };
                        subDiv.appendChild(fileLink);
                    });
                } else {
                    createSidebarMenu(data[key], subDiv, folderPath, level + 1);
                }
                parent.appendChild(subDiv);
            });
        }

        function toggleSection(id) {
            const s = document.getElementById(id);
            if (s) s.style.display = (s.style.display === "none" || s.style.display === "") ? "block" : "none";
        }

        // --- 5. CARGA DE MODELOS ---
        function loadMolecule(filePath, moleculeName) {
            const content = document.getElementById("dynamic-content");
            const encodedPath = filePath.split('/').map(seg => encodeURIComponent(seg)).join('/');
            const jsmolBgColor = isDarkMode ? "#161616" : "#fdfdfd";

            content.innerHTML = `
                <div class="molecule-card">
                    <header class="mol-header">
                        <h2>${moleculeName}</h2>
                        <span class="mol-badge">${moleculeName.includes('TS') ? 'TS' : 'INT'}</span>
                    </header>
                    <div id="jsmolContainer" class="jsmol-box" style="line-height:0;"></div>
                    <div class="toolbar">
                        <div class="tool-group">
                            <button class="btn-outline" onclick="Jmol.script(myJmol, 'reset')">üîÑ RESET</button>
                            <button class="btn-outline" onclick="Jmol.script(myJmol, hShow=!hShow ? 'display not _H':'display all')">H-Toggle</button>
                            <button class="btn-outline btn-zoom" onclick="Jmol.script(myJmol, 'zoom +20')">+</button>
                            <button class="btn-outline btn-zoom" onclick="Jmol.script(myJmol, 'zoom -20')">-</button>
                        </div>
                        <div class="tool-group checkboxes">
                            <label class="check-container"><input type="checkbox" onchange="Jmol.script(myJmol, this.checked ? 'spin on' : 'spin off')"> Spin</label>
                            <label class="check-container"><input type="checkbox" onchange="Jmol.script(myJmol, this.checked ? 'vibration on' : 'vibration off')"> Vibration</label>
                        </div>
                        <button class="btn-solid" onclick="Jmol.script(myJmol, 'write PNGJ \\'${moleculeName}.png\\'')">üì∏ Capture</button>
                        <button class="btn-outline" onclick="copyXYZ()">üìã Copy XYZ</button>
                    </div>
                    <div class="sci-panel">
                        <p class="pro-tip">TIP: Transitions states represent barriers. Enable vibration to visualize the mode.</p>
                        <h3>Technical Overview</h3>
                        <p>DFT-optimized geometry representing a stationary point in the catalytic cycle.</p>
                    </div>
                </div>
            `;

            const Info = { width: "100%", height: "100%", j2sPath: "j2s", color: jsmolBgColor, use: "HTML5", disableInitialConsole: true };
            myJmol = Jmol.getApplet("myJmol", Info);
            document.getElementById("jsmolContainer").innerHTML = Jmol.getAppletHtml(myJmol);
            Jmol.script(myJmol, `load "${encodedPath}"; model 2; set ambientPercent 25; set antialiasDisplay on; background "${jsmolBgColor}";`);
            setActiveLink(moleculeName);
        }

        // --- 6. MECANISMO INTERACTIVO ---
        function showMechanismL28() {
            const content = document.getElementById("dynamic-content");
            const bg = isDarkMode ? "#161616" : "#fdfdfd";

            content.innerHTML = `
                <div class="home-hero">
                    <h1>Interactive Mechanism Map</h1>
                    <p class="lead">Click on any energy level to load the 3D structure above.</p>
                    <div id="jsmolContainer" class="jsmol-box" style="height: 400px !important; margin-bottom:20px;"></div>
                    <div class="energy-profile-card">
                        <svg width="100%" viewBox="0 0 700 180" style="overflow: visible;">
                            ${renderSvgLevels()}
                        </svg>
                    </div>
                    <div class="sci-panel"><p>Explore the potential energy surface for 44a + L28.</p></div>
                </div>
            `;

            const Info = { width: "100%", height: "100%", j2sPath: "j2s", color: bg, use: "HTML5", disableInitialConsole: true };
            myJmol = Jmol.getApplet("myJmol", Info);
            document.getElementById("jsmolContainer").innerHTML = Jmol.getAppletHtml(myJmol);
        }

        function renderSvgLevels() {
            const height = 180;
            const yScale = (e) => height - 30 - (e * (height - 60) / 35);
            let html = `<line x1="40" y1="20" x2="40" y2="${height-20}" stroke="#ccc" stroke-width="1" />`;
            energyDataL28.forEach(p => {
                const y = yScale(p.energy);
                const color = p.color || 'var(--chem-teal)';
                html += `<g style="cursor:pointer" onclick="loadMolecule('${p.path}', '${p.id}')">
                    <line x1="${p.x-20}" y1="${y}" x2="${p.x+20}" y2="${y}" stroke="${color}" stroke-width="4" />
                    <text x="${p.x}" y="${y-10}" text-anchor="middle" font-size="12" fill="${color}" font-weight="bold">${p.energy}</text>
                    <text x="${p.x}" y="${y+20}" text-anchor="middle" font-size="9" fill="#888">${p.label}</text>
                </g>`;
            });
            return html;
        }

        // --- 7. HOME & UTILIDADES ---
        function showHomePage() {
            const content = document.getElementById("dynamic-content");
            content.innerHTML = `
                <div class="home-hero">
                    <h1>Interactive Mechanistic Viewer</h1>
                    <p class="lead">A 3D digital companion to the doctoral research of Daniel Marcos Atanes.</p>
                    <div class="oracle-card">
                        <span class="oracle-label">Gaussian Oracle</span>
                        <p id="quote-display">Analyzing potential energy surface...</p>
                        <button class="btn-ghost" onclick="loadRandomQuote()">Generate Tip</button>
                    </div>
                    <div class="info-grid">
                        <div class="info-item"><h3>3D Context</h3><p>Rotate and zoom into catalytic centers to understand regioselectivity.</p></div>
                        <div class="info-item"><h3>Raw Data</h3><p>Models are rendered directly from the calculation logs.</p></div>
                    </div>
                </div>
            `;
            loadRandomQuote();
        }

        function loadRandomQuote() {
            fetch('g16_quotes.txt').then(r => r.text()).then(t => {
                const q = t.split('\n\n').filter(x => x.trim() !== "");
                document.getElementById("quote-display").textContent = q[Math.floor(Math.random() * q.length)];
            }).catch(() => { document.getElementById("quote-display").textContent = "Gaussian job finished successfully."; });
        }

        function searchMenu() {
            const q = document.getElementById("sidebar-search").value.toLowerCase();
            document.querySelectorAll("#menu a.file-link").forEach(a => {
                a.style.display = a.textContent.toLowerCase().includes(q) ? "block" : "none";
            });
        }

        function setActiveLink(name) {
            document.querySelectorAll('#menu a').forEach(a => {
                a.classList.remove('active');
                if (a.textContent.includes(name)) a.classList.add('active');
            });
        }

        function copyXYZ() {
            const xyzData = Jmol.getPropertyAsString(myJmol, "extractModel");
            navigator.clipboard.writeText(xyzData).then(() => { alert("Coordinates copied to clipboard!"); });
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); }

        window.onload = () => {
            // CORRECCI√ìN: Usar 'menu' que es el ID real
            createSidebarMenu(structureData, document.getElementById("menu"));
            showHomePage();
        };
    </script>
    </body>
    </html>
