<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMA Thesis | 3D Mechanistic Viewer</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="styles.css">
    <script type="text/javascript" src="JSmol.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body class="light-mode">

    <button id="sidebar-toggle" class="mobile-toggle" onclick="toggleSidebar()">‚ò∞ Menu</button>

    <div id="main-container">
        <!-- SIDEBAR -->
        <nav id="sidebar">
            <div class="sidebar-sticky">
                <header>
                    <h1>Daniel Marcos</h1>
                    <p class="tagline">Mechanistic Explorer</p>

                    <div class="theme-switch-wrapper">
                        <label class="theme-switch">
                            <input type="checkbox" id="dark-mode-checkbox" onclick="toggleDarkMode()" />
                            <div class="slider round"></div>
                        </label>
                        <span id="theme-text">Light Mode</span>
                    </div>

                    <input type="text" id="sidebar-search" placeholder="Search intermediate..." onkeyup="searchMenu()">
                </header>

                <div id="menu">
                    <a href="#" id="home-link" class="active" onclick="showHomePage(); setActiveLink('home-link')">Home Overview</a>
                    <!-- √Årbol din√°mico inyectado aqu√≠ -->
                </div>

                <div class="sidebar-footer">
                    <a href="https://daniel-marcosatanes.github.io/" target="_blank">Back to Portfolio</a>
                </div>
            </div>
        </nav>

        <!-- CONTENIDO PRINCIPAL -->
        <main id="content">
            <div id="dynamic-content" class="container-pro">
                <!-- Se inyecta la Home o la Mol√©cula -->
            </div>
        </main>
    </div>

<script>
    // --- DATOS ORIGINALES (No modificados) ---
    const structureData = {
        "Structures section 7.1": [
            "4-m-bipy-OA-TS-Ir(R-H)(Bpin)3.log", "4-p-bipy-OA-TS-Ir(R-H)(Bpin)3.log",
            "5-m-phen-OA-TS-Ir(R-H)(Bpin)3.log", "5-OR-bipy-OA-TS-Ir(R-H)(Bpin)3.log",
            "5-p-phen-OA-TS-Ir(R-H)(Bpin)3.log", "bipy-OA-TS-Ir(R-H)(Bpin)3.log"
        ],
        "Structures section 7.2": {
            "3-CF3-Bipy": { "Meta": ["3-CF3-Bipy_TS_m-31.log"], "Ortho": ["3-CF3-Bipy_TS_o-2.log"], "Para": ["3-CF3-Bipy_TS_p-1.log"] },
            "4-CF3-Bipy": { "Meta": ["4-CF3-Bipy_TS_m-8.log"], "Ortho": ["4-CF3-Bipy_TS_o-3.log"], "Para": ["4-CF3-Bipy_TS_p-3.log"] },
            "5-CF3-Bipy": { "Meta": ["5-CF3-Bipy_TS_m-5.log"], "Ortho": ["5-CF3-Bipy_TSOA_o-1.log"], "Para": ["5-CF3-Bipy_TSOA_p-1.log"] },
            "Bipy": { "Meta": ["Bipy_TS_m-3.log"], "Ortho": ["Bipy_TS_o-1.log"], "Para": ["Bipy_TS_p-1.log"] }
        },
        "Structures section 7.3": {
            "Borylation of 44a": {
                "5-CF3-Bipy": {
                    "Ir(Bpin)": ["L27-Ir(Bpin).log"], "Ir(Bpin)3": ["L27-Ir(Bpin)3.log"], "Ir(Bpin)5": ["L27-Ir(Bpin)5.log"], "Ir(H)(Bpin)2": ["L27-Ir(H)(Bpin)2.log"],
                    "Isom-H": {
                        "œÉ-isoH-(R-Bpin)Ir(Bpin)2(H)": ["L27-œÉ-isoH-(R-Bpin)Ir(Bpin)2(H).log"],
                        "isoH-Ir(Bpin)3(R)(H)": ["L27-isoH-Ir(Bpin)3(R)(H).log"],
                        "isomH-TS-Ir(Bpin)3(R)(H)": ["L27-isomH-TS-Ir(Bpin)3(R)(H).log"],
                        "RE-TS-isoH-Ir(Bpin)3(R)(H)": ["L27-RE-TS-isoH-Ir(Bpin)3(R)(H).log"]
                    },
                    "OA": {
                        "OA-TS-Ir(R-H)(Bpin)3": ["L27-OA-TS-Ir(R-H)(Bpin)3.log"]
                    }
                }
            },
            "Rollover": {
                "Bipy": ["Bipy-Hemilabile-TS.log", "Bipy-Ir(LX)Bpin2.log"]
            }
        }
    };

    let myJmol = null;
    let isDarkMode = false;

    // --- MEJORA: L√≥gica de Men√∫ y Rutas ---
    function beautify(name) {
        return name.replace("Structures section ", "Chapter ")
                   .replace("Borylation of ", "Boryl. ");
    }

    function createSidebarMenu(data, parent, currentPath = "molecules/Structures", level = 0) {
        Object.keys(data).forEach((key) => {
            const folderPath = `${currentPath}/${key}`;
            const safeId = "ID_" + folderPath.replace(/[^a-zA-Z0-9]/g, '_');

            const link = document.createElement("a");
            link.textContent = beautify(key);
            link.className = level === 0 ? "folder-link level-0" : "folder-link";
            link.href = "#";
            link.onclick = (e) => { e.preventDefault(); toggleSection(safeId); };
            parent.appendChild(link);

            const subDiv = document.createElement("div");
            subDiv.id = safeId;
            subDiv.className = "submenu";
            subDiv.style.display = "none";

            if (Array.isArray(data[key])) {
                data[key].forEach((file) => {
                    const moleculeName = file.replace('.log', '');
                    const fileLink = document.createElement("a");
                    fileLink.textContent = moleculeName;
                    fileLink.className = "file-link";
                    fileLink.href = "#";
                    fileLink.onclick = (e) => {
                        e.preventDefault();
                        loadMolecule(`${folderPath}/${file}`, moleculeName);
                    };
                    subDiv.appendChild(fileLink);
                });
            } else {
                createSidebarMenu(data[key], subDiv, folderPath, level + 1);
            }
            parent.appendChild(subDiv);
        });
    }

    function toggleSection(id) {
        const s = document.getElementById(id);
        if (s) s.style.display = (s.style.display === "none" || s.style.display === "") ? "block" : "none";
    }

    // --- CARGA DE JSMOL ---
    function loadMolecule(filePath, moleculeName) {
        const content = document.getElementById("dynamic-content");
        const encodedPath = encodeURI(filePath);

        content.innerHTML = `
            <div class="molecule-card">
                <header class="mol-header">
                    <h2>${moleculeName}</h2>
                    <span class="badge">${moleculeName.includes('TS') ? 'Transition State' : 'Intermediate'}</span>
                </header>

                <div id="jsmolContainer" class="jsmol-box"></div>

                <div class="toolbar">
                    <div class="tool-group">
                        <button class="btn-outline" onclick="Jmol.script(myJmol, 'reset')">üîÑ Reset</button>
                        <button class="btn-outline" onclick="Jmol.script(myJmol, 'display all')">Show H</button>
                        <button class="btn-outline" onclick="Jmol.script(myJmol, 'display not _H')">Hide H</button>
                    </div>
                    <div class="tool-group checkboxes">
                        <label><input type="checkbox" onchange="Jmol.script(myJmol, this.checked ? 'spin on' : 'spin off')"> Spin</label>
                        <label><input type="checkbox" onchange="Jmol.script(myJmol, this.checked ? 'vibration on' : 'vibration off')"> Vibration</label>
                    </div>
                    <button class="btn-solid" onclick="Jmol.script(myJmol, 'write PNGJ \\'${moleculeName}.png\\'')">üì∏ Capture</button>
                </div>

                <div class="sci-info">
                    <p class="pro-tip">PRO TIP: Use the vibration toggle to see the imaginary frequency mode.</p>
                    <h3>Analysis</h3>
                    <p>Optimized geometry at the DFT level. This intermediate is key to understanding the catalytic cycle.</p>
                </div>
            </div>
        `;

        const Info = {
            width: "100%", height: 500, j2sPath: "j2s",
            color: isDarkMode ? "#121212" : "#FFFFFF",
            use: "HTML5", disableInitialConsole: true
        };
        myJmol = Jmol.getApplet("myJmol", Info);
        document.getElementById("jsmolContainer").innerHTML = Jmol.getAppletHtml(myJmol);
        Jmol.script(myJmol, `load "${encodedPath}"; model 2; set ambientPercent 25; set antialiasDisplay on;`);

        setActiveLink(moleculeName);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- P√ÅGINA DE INICIO ---
    function showHomePage() {
        const content = document.getElementById("dynamic-content");
        content.innerHTML = `
            <div class="home-hero">
                <h1>Interactive Mechanistic Viewer</h1>
                <p class="lead">A 3D digital supplement to the doctoral thesis of <strong>Daniel Marcos Atanes</strong>.</p>

                <div class="oracle-card">
                    <span class="label">Gaussian Quote Oracle</span>
                    <p id="quote-display">Analyzing potential energy surface...</p>
                    <button class="btn-ghost" onclick="loadRandomQuote()">Generate Tip</button>
                </div>

                <div class="guide-grid">
                    <div class="guide-item">
                        <h3>3D Perspective</h3>
                        <p>Rotate and zoom into catalytic centers to understand regioselectivity and steric hindrance.</p>
                    </div>
                    <div class="guide-item">
                        <h3>Direct Data</h3>
                        <p>Models are rendered directly from calculation output files (.log) used in the doctoral thesis.</p>
                    </div>
                </div>
            </div>
        `;
        loadRandomQuote();
    }

    function loadRandomQuote() {
        fetch('g16_quotes.txt').then(r => r.text()).then(t => {
            const q = t.split('\n\n').filter(x => x.trim() !== "");
            document.getElementById("quote-display").textContent = q[Math.floor(Math.random() * q.length)];
        }).catch(() => {
            document.getElementById("quote-display").textContent = "Gaussian job finished successfully.";
        });
    }

    function toggleDarkMode() {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode');
        document.getElementById('theme-text').textContent = isDarkMode ? "Dark Mode" : "Light Mode";
        if (myJmol) Jmol.script(myJmol, isDarkMode ? "background [x121212]" : "background white");
    }

    function searchMenu() {
        const q = document.getElementById("sidebar-search").value.toLowerCase();
        document.querySelectorAll("#menu a.file-link").forEach(a => {
            a.style.display = a.textContent.toLowerCase().includes(q) ? "block" : "none";
        });
    }

    function setActiveLink(name) {
        document.querySelectorAll('#menu a').forEach(a => {
            a.classList.remove('active');
            if (a.textContent.includes(name)) a.classList.add('active');
        });
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('show');
    }

    window.onload = () => {
        createSidebarMenu(structureData, document.getElementById("menu"));
        showHomePage();
    };
</script>
</body>
</html>
